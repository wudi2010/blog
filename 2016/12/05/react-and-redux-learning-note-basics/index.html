<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  
  <title>React + Redux 基础学习笔记 | 吴迪的技术博客 | 天下事有难易乎？为之，则难者亦易矣；不为，则易者亦难矣</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="theme-color" content="#3F51B5">
  
  
  <meta name="keywords" content="JavaScript,React,Redux">
  <meta name="description" content="零、环境搭建参考资料

英文原版文档
中文文档

首先要明确一点，虽然 redux 是由 flux 演变而来，但我们完全可以并且也应该抛开 react进行学习，这样可以避免一开始就陷入各种细节之中。
所以推荐使用 jsbin 进行调试学习，或者使用 react-create-app作为项目脚手架。
一、Redux是什么？
Redux is a predictable state container">
<meta property="og:type" content="article">
<meta property="og:title" content="React + Redux 基础学习笔记">
<meta property="og:url" content="https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/index.html">
<meta property="og:site_name" content="吴迪的技术博客">
<meta property="og:description" content="零、环境搭建参考资料

英文原版文档
中文文档

首先要明确一点，虽然 redux 是由 flux 演变而来，但我们完全可以并且也应该抛开 react进行学习，这样可以避免一开始就陷入各种细节之中。
所以推荐使用 jsbin 进行调试学习，或者使用 react-create-app作为项目脚手架。
一、Redux是什么？
Redux is a predictable state container">
<meta property="og:image" content="https://wudi2010.github.io/blog/blog/2016/12/05/react-and-redux-learning-note-basics/overview.png">
<meta property="og:updated_time" content="2016-12-06T07:28:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="React + Redux 基础学习笔记">
<meta name="twitter:description" content="零、环境搭建参考资料

英文原版文档
中文文档

首先要明确一点，虽然 redux 是由 flux 演变而来，但我们完全可以并且也应该抛开 react进行学习，这样可以避免一开始就陷入各种细节之中。
所以推荐使用 jsbin 进行调试学习，或者使用 react-create-app作为项目脚手架。
一、Redux是什么？
Redux is a predictable state container">
<meta name="twitter:image" content="https://wudi2010.github.io/blog/blog/2016/12/05/react-and-redux-learning-note-basics/overview.png">
  
    <link rel="alternative" href="/atom.xml" title="吴迪的技术博客" type="application/atom+xml">
  
  <link rel="shortcut icon" href="/blog/img/favicon.ico">
  <link rel="stylesheet" href="/blog/css/style.css?v=1.3.2">
</head>

<body>
  <div id="loading" class="active"></div>

  <aside id="menu"  >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      <div class="brand">
        <a href="/blog/" class="avatar waves-effect waves-circle waves-light">
          <img src="/blog/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">wudi</h5>
          <a href="mailto:28679382@qq.com" title="28679382@qq.com" class="mail">28679382@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/blog/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/blog/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/blog/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/blog/categories"  >
                <i class="icon icon-lg icon-th"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/wudi2010" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/blog/about"  >
                <i class="icon icon-lg icon-about"></i>
                关于
              </a>
            </li>
        
      </ul>

      <footer class="footer">
  <p><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0;vertical-align:middle;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAAllBMVEUAAAD///+rsapERER3d3eIiIjMzMzu7u4iIiKUmZO6v7rKzsoODg4RERFVVVUNDQ0NDg0PEA8zMzNLTEtbXltmZmZydnF9gn2AgICPkI+ZmZmqqqq7u7vFxsXIzMgNDQwZGRkgICAhISEkJSMnKCcuMC4xMzE5Ozk7PTtBQkFCQkJDQ0Nna2eGhoaHh4ezuLLGysbd3d1wVGpAAAAA4UlEQVR42q2T1xqCMAyFk7QsBQeKA9x7j/d/OSm22CpX0nzcpA1/T05aAOuBVkMAScQFHLnEwoCo2f1TnQIGoVMewjZEjVFN4GH1Ue1Cn2jWqwfsOOj6wDwGvotsl/c8lv7KIq1eLOsT0HMFHMIE/RZyHnlphryT9zyV+8WH5e8yQw3wnQvgAFxPTKUVi555SHR/lOfLMgVTeDlSfN+TaoUsiTyeIm+bCkHvCA2FUKG48LDtYBZBknsYP/G8NTw0gaaHyuQf4H5pecrB/FYCT2sL9zAfy1Xyjou6L8X2W7YcLyBZCRtnq/zfAAAAAElFTkSuQmCC" /></a></p>
  <p>吴迪的技术博客 &copy; 2016</p>
  <p>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme
  <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></p>
  <a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a>
</footer>

    </div>
  </div>
</aside>

  <main id="main">
    <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">React + Redux 基础学习笔记</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">React + Redux 基础学习笔记</h1>
        <h5 class="subtitle">
            
                <time datetime="2016-12-05T02:29:49.000Z" itemprop="datePublished" class="page-time">
  2016-12-05
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/blog/categories/前端/">前端</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <!--<h4>TOC</h4> -->
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#零、环境搭建"><span class="post-toc-text">零、环境搭建</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#一、Redux是什么？"><span class="post-toc-text">一、Redux是什么？</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-1-为什么选择-redux？"><span class="post-toc-text">1.1.为什么选择 redux？</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-2-三大原则（哲♂学）"><span class="post-toc-text">1.2. 三大原则（哲♂学）</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-2-1-单一数据源（Single-source-of-truth）"><span class="post-toc-text">1.2.1. 单一数据源（Single source of truth）</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-2-2-State-是只读的（State-is-read-only）"><span class="post-toc-text">1.2.2. State 是只读的（State is read-only）</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-2-3-使用纯函数来执行修改（Changes-are-made-with-pure-functions）"><span class="post-toc-text">1.2.3. 使用纯函数来执行修改（Changes are made with pure functions）</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#二、Redux-基础"><span class="post-toc-text">二、Redux 基础</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-1-action"><span class="post-toc-text">2.1. action</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-2-reducer"><span class="post-toc-text">2.2. reducer</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-3-store"><span class="post-toc-text">2.3. store</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-3-1-getState"><span class="post-toc-text">2.3.1. getState</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-3-2-dispatch-action"><span class="post-toc-text">2.3.2. dispatch(action)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-3-3-subscribe-listener"><span class="post-toc-text">2.3.3. subscribe(listener)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-3-4-replaceReducer-nextReducer"><span class="post-toc-text">2.3.4. replaceReducer(nextReducer)</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-4-createStore"><span class="post-toc-text">2.4. createStore</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-5-计数器例子"><span class="post-toc-text">2.5. 计数器例子</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#三、与-React-进行结合"><span class="post-toc-text">三、与 React 进行结合</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-1-通过-script-标签导入-react"><span class="post-toc-text">3.1. 通过 script 标签导入 react</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-2-用-Redux-和-React-实现-TodoApp"><span class="post-toc-text">3.2. 用 Redux 和 React 实现 TodoApp</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-2-1-分析与设计"><span class="post-toc-text">3.2.1. 分析与设计</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-2-2-编码实现"><span class="post-toc-text">3.2.2. 编码实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-action-部分"><span class="post-toc-text">1. action 部分</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-reducer-部分"><span class="post-toc-text">2. reducer 部分</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-view-部分"><span class="post-toc-text">3. view 部分</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#1-只有根组件"><span class="post-toc-text">(1). 只有根组件</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#2-组件拆分"><span class="post-toc-text">(2).组件拆分</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#3-增加容器组件"><span class="post-toc-text">(3). 增加容器组件</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#4-Provider"><span class="post-toc-text">(4). Provider</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#5-connect"><span class="post-toc-text">(5). connect</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#四、总结"><span class="post-toc-text">四、总结</span></a></li></ol>
        </nav>
    </aside>
    

<article id="post-react-and-redux-learning-note-basics"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">React + Redux 基础学习笔记</h1>
        <div class="post-meta">
            <time datetime="2016-12-05T02:29:49.000Z" itemprop="datePublished" class="post-time">
  2016-12-05
</time>

            <br/>
            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/blog/categories/前端/">前端</a></li></ul>



        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="零、环境搭建"><a href="#零、环境搭建" class="headerlink" title="零、环境搭建"></a>零、环境搭建</h1><p><strong>参考资料</strong></p>
<ul>
<li><a href="http://redux.js.org/" target="_blank" rel="external">英文原版文档</a></li>
<li><a href="http://cn.redux.js.org/" target="_blank" rel="external">中文文档</a></li>
</ul>
<p>首先要明确一点，虽然 redux 是由 flux 演变而来，但我们完全可以并且也应该抛开 react进行学习，这样可以避免一开始就陷入各种细节之中。</p>
<p>所以推荐使用 <a href="https://jsbin.com/" target="_blank" rel="external">jsbin</a> 进行调试学习，或者使用 <a href="https://github.com/facebookincubator/create-react-app" target="_blank" rel="external">react-create-app</a>作为项目脚手架。</p>
<h1 id="一、Redux是什么？"><a href="#一、Redux是什么？" class="headerlink" title="一、Redux是什么？"></a>一、Redux是什么？</h1><blockquote>
<p>Redux is a predictable state container for JavaScript apps.<br>Redux 是一个 JavaScript 状态容器，提供可预测化的状态管理。</p>
</blockquote>
<img src="/blog/2016/12/05/react-and-redux-learning-note-basics/overview.png" alt="overview.png" title="">
<p><strong>先不要在意那些细节</strong></p>
<ul>
<li>总的来说，redux 使用 store 保存并管理页面中的各种状态（state）</li>
<li>当需要改变 state 时，使用 dispatch 调用 action creators 触发 action</li>
<li>接着使用纯函数（pure function）reducer 来处理这些 action，它会根据当前 state 和 action 返回（注意这里不是修改）新的 state</li>
<li>view 层可以对于 state 进行订阅（subscribe），这样就可以得到新的 state，从而可以刷新界面（所以十分适合数据驱动的前端框架）</li>
</ul>
<blockquote>
<p>纯函数：简单的说就是对于同样的输入总是返回同样的输出，并且没有副作用的函数。（推荐学习了解下函数式编程）</p>
</blockquote>
<h2 id="1-1-为什么选择-redux？"><a href="#1-1-为什么选择-redux？" class="headerlink" title="1.1.为什么选择 redux？"></a>1.1.为什么选择 redux？</h2><ul>
<li>随着 JavaScript 单页应用开发日趋复杂，JavaScript 需要管理比任何时候都要多的 state （状态）。 这些 state 可能包括服务器响应、缓存数据、本地生成尚未持久化到服务器的数据，也包括 UI 状态，如激活的路由，被选中的标签，是否显示加载动效或者分页器等等。</li>
<li>管理不断变化的 state 非常困难。如果一个 model 的变化会引起另一个 model 变化，那么当 view 变化时，就可能引起对应 model以及另一个 model 的变化，依次地，可能会引起另一个 view 的变化。直至你搞不清楚到底发生了什么。state 在什么时候，由于什么原因，如何变化已然不受控制。 当系统变得错综复杂的时候，想重现问题或者添加新功能就会变得举步维艰。</li>
<li>如果这还不够糟糕，考虑一些来自前端开发领域的新需求，如更新调优、服务端渲染、路由跳转前请求数据等等。前端开发者正在经受前所未有的复杂性，难道就这么放弃了吗？当然不是。</li>
<li>这里的复杂性很大程度上来自于：我们总是将两个难以厘清的概念混淆在一起：<em>变化</em>和<em>异步</em>。 我称它们为曼妥思和可乐。如果把二者分开，能做的很好，但混到一起，就变得一团糟。一些库如 React 试图在视图层禁止异步和直接操作 DOM 来解决这个问题。美中不足的是，React 依旧把处理 state 中数据的问题留给了你。Redux就是为了帮你解决这个问题。</li>
<li>跟随 Flux、CQRS 和 Event Sourcing 的脚步，通过限制更新发生的时间和方式，Redux 试图让 state 的变化变得可预测。这些限制条件反映在 Redux 的 三大原则中。</li>
</ul>
<p><strong>简单总结就是使用 Redux 我们就可以没有蛀牙（大雾）</strong></p>
<ul>
<li>拥有可预测（predictable）的应用状态，所以应用的行为也是可预测的</li>
<li>因为 reducer 是纯函数，所以方便对于状态迁移进行自动化测试</li>
<li>方便地记录日志，甚至实现时间旅行（time travel）</li>
</ul>
<h2 id="1-2-三大原则（哲♂学）"><a href="#1-2-三大原则（哲♂学）" class="headerlink" title="1.2. 三大原则（哲♂学）"></a>1.2. 三大原则（哲♂学）</h2><h3 id="1-2-1-单一数据源（Single-source-of-truth）"><a href="#1-2-1-单一数据源（Single-source-of-truth）" class="headerlink" title="1.2.1. 单一数据源（Single source of truth）"></a>1.2.1. 单一数据源（Single source of truth）</h3><p>整个应用的 state 被储存在一棵 object tree 中，并且这个 object tree 只存在于唯一一个 store 中。</p>
<ul>
<li>来自服务端的 state 可以在无需编写更多代码的情况下被序列化并注入到客户端中</li>
<li>便于调试，在开发时可以将状态保存在本地</li>
<li>Undo/Redo 可以轻松实现，从而实现时间旅行</li>
</ul>
<h3 id="1-2-2-State-是只读的（State-is-read-only）"><a href="#1-2-2-State-是只读的（State-is-read-only）" class="headerlink" title="1.2.2. State 是只读的（State is read-only）"></a>1.2.2. State 是只读的（State is read-only）</h3><p>惟一改变 state 的方法就是触发 action，action 是一个用于描述已发生事件的普通对象。</p>
<p>因为所有的修改都被集中化处理，且严格按照一个接一个的顺序执行，（dispatch 同步调用 reduce 函数）因此不用担心 race condition 的出现。 Action 就是普通对象而已，因此它们可以被日志打印、序列化、储存、后期调试或测试时回放出来。</p>
<h3 id="1-2-3-使用纯函数来执行修改（Changes-are-made-with-pure-functions）"><a href="#1-2-3-使用纯函数来执行修改（Changes-are-made-with-pure-functions）" class="headerlink" title="1.2.3. 使用纯函数来执行修改（Changes are made with pure functions）"></a>1.2.3. 使用纯函数来执行修改（Changes are made with pure functions）</h3><p>为了描述 action 如何改变 state tree ，你需要编写 reducer。</p>
<p>Reducer 只是纯函数，它接收先前的 state 和 action，并返回新的 state。刚开始你可以只有一个 reducer，随着应用变大，你可以把它拆成多个小的 reducers，分别独立地操作 state tree 的不同部分。</p>
<h1 id="二、Redux-基础"><a href="#二、Redux-基础" class="headerlink" title="二、Redux 基础"></a>二、Redux 基础</h1><h2 id="2-1-action"><a href="#2-1-action" class="headerlink" title="2.1. action"></a>2.1. action</h2><p>Action 就是一个普通的 JavaScript Object。</p>
<p>redux 唯一限制的一点是必须有一个 type 属性用来表示执行哪种操作，值最好用字符串，而不是 Symbols，因为字符串是可被序列化的。</p>
<p>其他属性用来传递此次操作所需传递的数据，redux 对此不作限制，但是在设计时可以参照 Flux 标准 Action。</p>
<p><strong>简单总结 Flux Standard action 就是</strong></p>
<blockquote>
<ol>
<li>一个 action 必须是一个 JavaScript Object，并且有一个 type 属性。</li>
<li>一个 action 可以有 payload/error/meta 属性。</li>
<li>一个 action 不能有其他属性。</li>
</ol>
</blockquote>
<h2 id="2-2-reducer"><a href="#2-2-reducer" class="headerlink" title="2.2. reducer"></a>2.2. reducer</h2><p>Reducer 的工作就是接收旧的 state 和 action，返回新的 state。</p>
<blockquote>
<p>(previousState, action) =&gt; newState</p>
</blockquote>
<p>之所以称作 reducer 是因为它将被传递给 [Array.prototype.reduce(reducer, ?initialValue)] 方法。保持 reducer 纯净非常重要。永远不要在 reducer 里做这些操作：</p>
<ul>
<li>修改传入参数；</li>
<li>执行有副作用的操作，如 API 请求和路由跳转；</li>
<li>调用非纯函数，如 Date.now() 或 Math.random()。</li>
</ul>
<h2 id="2-3-store"><a href="#2-3-store" class="headerlink" title="2.3. store"></a>2.3. store</h2><p>Store 就是用来维持应用所有的 state 树的一个对象。</p>
<p>在 redux 中只有一个 store（区别于 flux 的多个 store），在 store 中保存所有的 state，可以把它当成一个封装了 state 的类。而除了对其 dispatch 一个 action 以外无法改变内部的 state。</p>
<p>在实际操作中我们只需要把根部的 reducer 函数传递给 createStore 就可以得到一个 store。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'SOME_ACTION'</span>:</div><div class="line">            <span class="comment">// 一些操作</span></div><div class="line">            <span class="keyword">return</span> newState; <span class="comment">// 返回新状态</span></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">const</span> store = createStore(reducer);</div></pre></td></tr></table></figure>
<p><strong>redux 中提供了这几个 api 操作 store</strong></p>
<h3 id="2-3-1-getState"><a href="#2-3-1-getState" class="headerlink" title="2.3.1. getState"></a>2.3.1. getState</h3><p>返回当前的整个 state 树。</p>
<h3 id="2-3-2-dispatch-action"><a href="#2-3-2-dispatch-action" class="headerlink" title="2.3.2. dispatch(action)"></a>2.3.2. dispatch(action)</h3><p>分发 action 给对应的 reducer。</p>
<p>该函数会调用 getState() 和传入的 action 以【同步】的方式调用 store 的 reduce 函数，然后返回新的 state。从而 state 得到了更新，并且变化监听器（change listener）会被触发。（对于异步操作则将其放到了 action creator 这个步骤）</p>
<h3 id="2-3-3-subscribe-listener"><a href="#2-3-3-subscribe-listener" class="headerlink" title="2.3.3. subscribe(listener)"></a>2.3.3. subscribe(listener)</h3><p>为 store 添加一个变化监听器，每当 dispatch 的时候就会执行，你可以在 listener（回调函数）中使用 getState() 来得到当前的 state。</p>
<p>这个 api 设计的挺有意思，它会返回一个函数，而你执行这个函数后就可以取消订阅。</p>
<h3 id="2-3-4-replaceReducer-nextReducer"><a href="#2-3-4-replaceReducer-nextReducer" class="headerlink" title="2.3.4. replaceReducer(nextReducer)"></a>2.3.4. replaceReducer(nextReducer)</h3><p>替换 store 当前用来计算 state 的 reducer。</p>
<p>这是一个高级 API。只有在你需要实现代码分隔，而且需要立即加载一些 reducer 的时候才可能会用到它。在实现 Redux 热加载机制的时候也可能会用到。</p>
<h2 id="2-4-createStore"><a href="#2-4-createStore" class="headerlink" title="2.4. createStore"></a>2.4. createStore</h2><p>忽略各种类型判断，实现一个最简的 createStore 可以用以下代码。参考资料</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> createStore = <span class="function">(<span class="params">reducer</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> state;</div><div class="line">    <span class="keyword">let</span> listeners = [];</div><div class="line">    <span class="keyword">const</span> getState = <span class="function"><span class="params">()</span> =&gt;</span> state;</div><div class="line">    <span class="keyword">const</span> dispatch = <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</div><div class="line">        state = reducer(state, action); <span class="comment">// 调用 reducer</span></div><div class="line">        listeners.forEach(<span class="function"><span class="params">listener</span> =&gt;</span> listener()); <span class="comment">// 调用所有变化监听器</span></div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">const</span> subscribe = <span class="function">(<span class="params">listener</span>) =&gt;</span> &#123;</div><div class="line">        listeners.push(listener);</div><div class="line">        <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">            <span class="comment">// 返回解除监听函数</span></div><div class="line">            listeners = listeners.filter(<span class="function"><span class="params">l</span> =&gt;</span> l !== listener);</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">    dispatch(&#123;&#125;); <span class="comment">// 初始化</span></div><div class="line">    <span class="keyword">return</span> &#123; getState, dispatch, subscribe &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="2-5-计数器例子"><a href="#2-5-计数器例子" class="headerlink" title="2.5. 计数器例子"></a>2.5. 计数器例子</h2><ul>
<li>纯 JavaScript 不涉及界面（可以在右侧 console 中尝试 store.dispatch）<br><a class="jsbin-embed" href="http://jsbin.com/jetitub/embed?js,console" target="_blank" rel="external">JS Bin on jsbin.com</a><script src="http://static.jsbin.com/js/embed.min.js?3.40.2"></script></li>
<li>增加界面<br><a class="jsbin-embed" href="http://jsbin.com/kegumih/embed?html,js,output" target="_blank" rel="external">JS Bin on jsbin.com</a><script src="http://static.jsbin.com/js/embed.min.js?3.40.2"></script></li>
</ul>
<h1 id="三、与-React-进行结合"><a href="#三、与-React-进行结合" class="headerlink" title="三、与 React 进行结合"></a>三、与 React 进行结合</h1><h2 id="3-1-通过-script-标签导入-react"><a href="#3-1-通过-script-标签导入-react" class="headerlink" title="3.1. 通过 script 标签导入 react"></a>3.1. 通过 script 标签导入 react</h2><p>实现同样功能的 Counter</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 引入 createStore 方法</span></div><div class="line"><span class="keyword">const</span> &#123; createStore &#125; = Redux;</div><div class="line"><span class="comment">// var createStore = Redux.createStore;</span></div><div class="line"><span class="comment">// import &#123; createStore &#125; from 'redux';</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> counter = <span class="function">(<span class="params">state = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'INCREMENT'</span>:</div><div class="line">            <span class="keyword">return</span> state + <span class="number">1</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'DECREMENT'</span>:</div><div class="line">            <span class="keyword">return</span> state - <span class="number">1</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> store = createStore(counter); <span class="comment">// 创建 store 并绑定 reducer</span></div><div class="line"></div><div class="line"><span class="comment">// dump component</span></div><div class="line"><span class="keyword">const</span> Counter = (&#123; </div><div class="line">    value,</div><div class="line">    onIncrement,</div><div class="line">    onDecrement</div><div class="line">&#125;) =&gt; (</div><div class="line">    &lt;div&gt;</div><div class="line">        &lt;h1&gt;&#123;value&#125;&lt;/h1&gt;</div><div class="line">        &lt;button onClick=&#123;onIncrement&#125;&gt;+&lt;/button&gt;</div><div class="line">        &lt;button onClick=&#123;onDecrement&#125;&gt;-&lt;/button&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">);</div><div class="line"><span class="keyword">const</span> render = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    ReactDOM.render(</div><div class="line">        &lt;Counter </div><div class="line">            value=&#123;store.getState()&#125; </div><div class="line">            onIncrement=&#123;() =&gt; store.dispatch(&#123; type: 'INCREMENT' &#125;)&#125; </div><div class="line">            onDecrement=&#123;() =&gt; store.dispatch(&#123; type: 'DECREMENT' &#125;)&#125; </div><div class="line">        /&gt;,</div><div class="line">        document.getElementById('container')</div><div class="line">    );</div><div class="line">&#125;;</div><div class="line"></div><div class="line">store.subscribe(render); // change listener 监听状态变化，一旦变化则触发回调函数</div><div class="line">render();</div></pre></td></tr></table></figure>
<h2 id="3-2-用-Redux-和-React-实现-TodoApp"><a href="#3-2-用-Redux-和-React-实现-TodoApp" class="headerlink" title="3.2. 用 Redux 和 React 实现 TodoApp"></a>3.2. 用 Redux 和 React 实现 TodoApp</h2><p>在添加 react-redux 之前，为了体会下 react-redux 的作用，首先来实现一个比计数器更复杂一点儿的 TodoApp 例子~</p>
<h3 id="3-2-1-分析与设计"><a href="#3-2-1-分析与设计" class="headerlink" title="3.2.1. 分析与设计"></a>3.2.1. 分析与设计</h3><p><strong>1. 容器组件 V.S. 展示组件</strong><br>组件一般分为</p>
<p>容器组件（Smart/Container Components）<br>展示组件（Dumb/Presentational Components）</p>
<table>
<thead>
<tr>
<th></th>
<th>容器组件</th>
<th>展示组件</th>
</tr>
</thead>
<tbody>
<tr>
<td>Location</td>
<td>最顶层，路由处理</td>
<td>中间和子组件</td>
</tr>
<tr>
<td>Aware of Redux</td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td>读取数据</td>
<td>从Redux获取state</td>
<td>从props获取数据</td>
</tr>
<tr>
<td>修改数据</td>
<td>向Redux派发actions</td>
<td>从props回掉函数</td>
</tr>
</tbody>
</table>
<p>最佳实践一般是由容器组件负责一些数据的获取，进行 dispatch 等操作。而展示组件组件不应该关心逻辑，所有数据都通过 props 传入。</p>
<p>这样才能达到展示组件可以在多处复用，在具体复用时就是通过容器组件将其包装，为其提供所需的各种数据。</p>
<p><strong>2. 应用设计</strong></p>
<ul>
<li>一个 TodoApp 包含了三个部分：<ul>
<li>顶部的 AddTodo 输入部分</li>
<li>中间的 TodoList 展示部分</li>
<li>底部的 Footer 过滤部分</li>
</ul>
</li>
<li>State 应该包含：<ul>
<li>filter：过滤 todos 的条件<ul>
<li>SHOW_ALL</li>
<li>SHOW_ACTIVE</li>
<li>SHOW_COMPLETED</li>
<li>todos：所有的 todo</li>
<li>todo：包含 id、text 和 completed</li>
</ul>
</li>
</ul>
</li>
<li>然而传到应用中的 props 只需要：<ul>
<li>visibleTodos：过滤后的 todos</li>
<li>filter：过滤条件</li>
</ul>
</li>
<li>Action 应该有三种：<ul>
<li>ADD_TODO</li>
<li>TOGGLE_TODO</li>
<li>SET_VISIBILITY_FILTER<h3 id="3-2-2-编码实现"><a href="#3-2-2-编码实现" class="headerlink" title="3.2.2. 编码实现"></a>3.2.2. 编码实现</h3></li>
</ul>
</li>
</ul>
<h4 id="1-action-部分"><a href="#1-action-部分" class="headerlink" title="1. action 部分"></a>1. action 部分</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 暂且使用数字作为 id</span></div><div class="line"><span class="keyword">let</span> nextTodoId = <span class="number">0</span>;</div><div class="line"><span class="comment">/*-- action creators --*/</span></div><div class="line"><span class="keyword">const</span> addTodo = <span class="function">(<span class="params">text</span>) =&gt;</span> (</div><div class="line">    &#123; <span class="attr">type</span>: <span class="string">'ADD_TODO'</span>, <span class="attr">id</span>: nextTodoId++, text &#125;</div><div class="line">);</div><div class="line"><span class="keyword">const</span> toggleTodo = <span class="function">(<span class="params">id</span>) =&gt;</span> (</div><div class="line">    &#123; <span class="attr">type</span>: <span class="string">'TOGGLE_TODO'</span>, id &#125;</div><div class="line">);</div><div class="line"><span class="keyword">const</span> setVisibilityFilter = <span class="function">(<span class="params">filter</span>) =&gt;</span> (</div><div class="line">    &#123; <span class="attr">type</span>: <span class="string">'SET_VISIBILITY_FILTER'</span>, filter &#125;</div><div class="line">);</div></pre></td></tr></table></figure>
<h4 id="2-reducer-部分"><a href="#2-reducer-部分" class="headerlink" title="2. reducer 部分"></a>2. reducer 部分</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 默认初始状态</span></div><div class="line"><span class="keyword">const</span> initialState = &#123; <span class="attr">filter</span>: <span class="string">'SHOW_ALL'</span>, <span class="attr">todos</span>: [] &#125;;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">rootReducer</span>(<span class="params">state = initialState, action</span>) </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</div><div class="line">            <span class="comment">// 对象解构</span></div><div class="line">            <span class="keyword">const</span> &#123; id, text &#125; = action;</div><div class="line">            <span class="keyword">return</span> &#123;</div><div class="line">                ...state,</div><div class="line">                <span class="attr">todos</span>: [</div><div class="line">                    ...state.todos,</div><div class="line">                    &#123; id, text, <span class="attr">completed</span>: <span class="literal">false</span> &#125;,</div><div class="line">                ],</div><div class="line">            &#125;;</div><div class="line">        <span class="keyword">case</span> <span class="string">'TOGGLE_TODO'</span>:</div><div class="line">            <span class="keyword">return</span> &#123;</div><div class="line">                ...state,</div><div class="line">                <span class="attr">todos</span>: state.todos.map(<span class="function"><span class="params">todo</span> =&gt;</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (todo.id !== action.id) <span class="keyword">return</span> todo;</div><div class="line">                    <span class="keyword">return</span> &#123;</div><div class="line">                        ...todo,</div><div class="line">                        <span class="attr">completed</span>: !todo.completed,</div><div class="line">                    &#125;;</div><div class="line">                &#125;),</div><div class="line">            &#125;;</div><div class="line">        <span class="keyword">case</span> <span class="string">'SET_VISIBILITY_FILTER'</span>:</div><div class="line">            <span class="keyword">return</span> &#123;</div><div class="line">                ...state,</div><div class="line">                <span class="attr">filter</span>: action.filter,</div><div class="line">            &#125;;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意!<br>1.不要直接修改原有的 state，而是返回一个新的 state。可以使用 Object.assign() 新建一个新的 state。不能这样使用 Object.assign(state, { visibilityFilter: action.filter })，因为它会改变第一个参数的值。你必须把第一个参数设置为空对象。你也可以开启对 ES7 提案对象展开运算符的支持, 从而使用 { …state, …newState } 达到相同的目的。<br>2.在 default 的情况下返回旧的 state，用来兼容遇到未知的 action 这样的错误。</p>
</blockquote>
<p><strong>拆分 reducer</strong><br>目前代码看着比较冗长，其实在逻辑上 todos 的处理和 filter 的处理应该分开，所以在 state 没有互相耦合时，可以将其拆分，从而让 reducer 精细地对于对应 state 的子树进行处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 处理单个 todo</span></div><div class="line"><span class="keyword">const</span> todoReducer = <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</div><div class="line">            <span class="keyword">return</span> &#123;</div><div class="line">                <span class="attr">id</span>: action.id,</div><div class="line">                <span class="attr">text</span>: action.text,</div><div class="line">                <span class="attr">completed</span>: <span class="literal">false</span>,</div><div class="line">            &#125;;</div><div class="line">        <span class="keyword">case</span> <span class="string">'TOGGLE_TODO'</span>:</div><div class="line">            <span class="keyword">if</span> (state.id !== action.id) <span class="keyword">return</span> state;</div><div class="line">            <span class="keyword">return</span> &#123;</div><div class="line">                ...state,</div><div class="line">                <span class="attr">completed</span>: !state.completed,</div><div class="line">            &#125;;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 处理 todos</span></div><div class="line"><span class="keyword">const</span> todosReducer = <span class="function">(<span class="params">state = [], action</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</div><div class="line">            <span class="keyword">return</span> [</div><div class="line">                ...state,</div><div class="line">                todoReducer(<span class="literal">undefined</span>, action),</div><div class="line">            ];</div><div class="line">        <span class="keyword">case</span> <span class="string">'TOGGLE_TODO'</span>:</div><div class="line">            <span class="keyword">return</span> state.map(<span class="function"><span class="params">t</span> =&gt;</span> todoReducer(t, action));</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">    &#125;;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 处理 filter</span></div><div class="line"><span class="keyword">const</span> filterReducer = <span class="function">(<span class="params">state = <span class="string">'SHOW_ALL'</span>, action</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'SET_VISIBILITY_FILTER'</span>:</div><div class="line">            <span class="keyword">return</span> action.filter;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">    &#125;;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">const</span> rootReducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> (&#123;</div><div class="line">    <span class="attr">todos</span>: todosReducer(state.todos, action),</div><div class="line">    <span class="attr">filter</span>: filterReducer(state.filter, action),</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>注意观察最后的 rootReducer 函数，返回的是一个经过各种 reducer 处理过并合并后的新 state。</p>
<p>然鹅，注意这里 <code>todos: todos(state.todos, action)</code>, 传入 state.todos，返回的一定也是 todos（因为都是 state 树上的节点）。</p>
<p>所以 redux 提供了很实用的 <code>combineReducers</code> api，用于简化 reducer 的合并。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"><span class="keyword">const</span> rootReducer = combineReducers(&#123;</div><div class="line">    <span class="attr">todos</span>: todosReducer,</div><div class="line">    <span class="attr">filter</span>: filterReducer,</div><div class="line">&#125;);</div><div class="line"><span class="comment">// initialState 可以作为第二个参数传入</span></div><div class="line"><span class="keyword">const</span> store = createStore(rootReducer, initialState);</div></pre></td></tr></table></figure>
<p>并且如果 reducer 与 state 节点同名的话（即 todosReducer -&gt; todos）还能通过 es6 的语法更进一步地简化<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"><span class="keyword">const</span> rootReducer = combineReducers(&#123; todos, filter &#125;);</div><div class="line"><span class="comment">// initialState 可以作为第二个参数传入</span></div><div class="line"><span class="keyword">const</span> store = createStore(rootReducer, initialState);</div></pre></td></tr></table></figure></p>
<p>随着应用的膨胀，我们还可以将拆分后的 reducer 放到不同的文件中, 以保持其独立性并用于专门处理不同的数据域。</p>
<h4 id="3-view-部分"><a href="#3-view-部分" class="headerlink" title="3. view 部分"></a>3. view 部分</h4><h5 id="1-只有根组件"><a href="#1-只有根组件" class="headerlink" title="(1). 只有根组件"></a>(1). 只有根组件</h5><p>首先只写一个根组件 <code>&lt;TodoApp/&gt;</code> ，store通过props传入TodoApp,并在生命周期的componentDidMount 和 componentWillUnmount时分别订阅与取消订阅</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TodoApp</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="comment">// 订阅 store 的变化</span></div><div class="line">    componentDidMount() &#123;</div><div class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.props;</div><div class="line">        <span class="keyword">this</span>.unsubscribe = store.subscribe(</div><div class="line">            <span class="keyword">this</span>.forceUpdate.bind(<span class="keyword">this</span>)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 取消订阅</span></div><div class="line">    componentWillUnmount() &#123;</div><div class="line">        <span class="keyword">this</span>.unsubscribe();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 渲染单个 todo</span></div><div class="line">    _renderTodo(todo) &#123;</div><div class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.props;</div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            &lt;li</div><div class="line">                key=&#123;todo.id&#125;</div><div class="line">                onClick=&#123;() =&gt; store.dispatch(toggleTodo(todo.id))&#125;</div><div class="line">                style=&#123;&#123;</div><div class="line">                    textDecoration: todo.completed</div><div class="line">                        ? 'line-through'</div><div class="line">                        : 'none',</div><div class="line">                    cursor: todo.completed</div><div class="line">                        ? 'default'</div><div class="line">                        : 'pointer',</div><div class="line">                &#125;&#125;</div><div class="line">            &gt;</div><div class="line">                &#123;todo.text&#125;</div><div class="line">            &lt;/li&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 根据当前 filter 是否匹配，返回字符串或是 a 链接</span></div><div class="line">    _renderFilter(renderFilter, name) &#123;</div><div class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.props;</div><div class="line">        <span class="keyword">const</span> &#123; filter &#125; = store.getState();</div><div class="line">        <span class="keyword">if</span> (renderFilter === filter) <span class="keyword">return</span> name;</div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            &lt;a href='#' onClick=&#123;e =&gt; &#123;</div><div class="line">                e.preventDefault();</div><div class="line">                store.dispatch(setVisibilityFilter(renderFilter))</div><div class="line">            &#125;&#125;&gt;</div><div class="line">                &#123;name&#125;</div><div class="line">            &lt;/a&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 根据当前 filter 过滤需要渲染的 todos</span></div><div class="line">    _getVisibleTodos(todos, filter) &#123;</div><div class="line">        <span class="keyword">switch</span> (filter) &#123;</div><div class="line">            <span class="keyword">case</span> <span class="string">'SHOW_ALL'</span>:</div><div class="line">                <span class="keyword">return</span> todos;</div><div class="line">            <span class="keyword">case</span> <span class="string">'SHOW_COMPLETED'</span>:</div><div class="line">                <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">todo</span> =&gt;</span> todo.completed);</div><div class="line">            <span class="keyword">case</span> <span class="string">'SHOW_ACTIVE'</span>:</div><div class="line">                <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">todo</span> =&gt;</span> !todo.completed);</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">return</span> todos;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.props;</div><div class="line">        <span class="keyword">const</span> &#123; todos, filter &#125; = store.getState();</div><div class="line">        <span class="keyword">let</span> input;</div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            &lt;div&gt;</div><div class="line">                &#123;/* AddTodo */&#125;</div><div class="line">                &lt;input type="text" ref=&#123;node =&gt; input = node&#125; /&gt;</div><div class="line">                &lt;button onClick=&#123;() =&gt; &#123;</div><div class="line">                    if (!input.value) return;</div><div class="line">                    store.dispatch(addTodo(input.value));</div><div class="line">                    input.value = '';</div><div class="line">                &#125;&#125;&gt;</div><div class="line">                    addTodo</div><div class="line">                &lt;/button&gt;</div><div class="line">                &#123;/* TodoList */&#125;</div><div class="line">                &lt;ul&gt;</div><div class="line">                    &#123;this._getVisibleTodos(todos, filter)</div><div class="line">                        .map(this._renderTodo.bind(this))</div><div class="line">                    &#125;</div><div class="line">                &lt;/ul&gt;</div><div class="line">                &#123;/* Footer */&#125;</div><div class="line">                &lt;p&gt;</div><div class="line">                    Show:</div><div class="line">                    &#123;' '&#125;</div><div class="line">                    &#123;this._renderFilter('SHOW_ALL', 'all')&#125;</div><div class="line">                    &#123;', '&#125;</div><div class="line">                    &#123;this._renderFilter('SHOW_COMPLETED', 'completed')&#125;</div><div class="line">                    &#123;', '&#125;</div><div class="line">                    &#123;this._renderFilter('SHOW_ACTIVE', 'active')&#125;</div><div class="line">                &lt;/p&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>TodoApp 只有根组件</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 引入 createStore 方法</span></div><div class="line"><span class="keyword">const</span> &#123; createStore, combineReducers &#125; = Redux;</div><div class="line"><span class="keyword">const</span> &#123; Component &#125; = React;</div><div class="line"></div><div class="line"><span class="comment">// 暂且使用数字作为 id</span></div><div class="line"><span class="keyword">let</span> nextTodoId = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="comment">/*-- action creators --*/</span></div><div class="line"><span class="keyword">const</span> addTodo = <span class="function">(<span class="params">text</span>) =&gt;</span> (</div><div class="line">    &#123; <span class="attr">type</span>: <span class="string">'ADD_TODO'</span>, <span class="attr">id</span>: nextTodoId++, text &#125;</div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">const</span> toggleTodo = <span class="function">(<span class="params">id</span>) =&gt;</span> (</div><div class="line">    &#123; <span class="attr">type</span>: <span class="string">'TOGGLE_TODO'</span>, id &#125;</div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">const</span> setVisibilityFilter = <span class="function">(<span class="params">filter</span>) =&gt;</span> (</div><div class="line">    &#123; <span class="attr">type</span>: <span class="string">'SET_VISIBILITY_FILTER'</span>, filter &#125;</div><div class="line">);</div><div class="line"></div><div class="line"><span class="comment">/*-- reducers --*/</span></div><div class="line"><span class="comment">// 默认初始状态</span></div><div class="line"><span class="keyword">const</span> initialState = &#123; <span class="attr">filter</span>: <span class="string">'SHOW_ALL'</span>, <span class="attr">todos</span>: [] &#125;;</div><div class="line"></div><div class="line"><span class="comment">// 处理单个 todo</span></div><div class="line"><span class="keyword">const</span> todo = <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</div><div class="line">            <span class="keyword">return</span> &#123;</div><div class="line">                <span class="attr">id</span>: action.id,</div><div class="line">                <span class="attr">text</span>: action.text,</div><div class="line">                <span class="attr">completed</span>: <span class="literal">false</span>,</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="string">'TOGGLE_TODO'</span>:</div><div class="line">            <span class="keyword">if</span> (state.id !== action.id) <span class="keyword">return</span> state;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> &#123;</div><div class="line">                ...state,</div><div class="line">                <span class="attr">completed</span>: !state.completed,</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 处理 todos</span></div><div class="line"><span class="keyword">const</span> todos = <span class="function">(<span class="params">state = [], action</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</div><div class="line">            <span class="keyword">return</span> [</div><div class="line">                ...state,</div><div class="line">                todo(<span class="literal">undefined</span>, action),</div><div class="line">            ];</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="string">'TOGGLE_TODO'</span>:</div><div class="line">            <span class="keyword">return</span> state.map(<span class="function"><span class="params">t</span> =&gt;</span> todo(t, action));</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 处理 filter</span></div><div class="line"><span class="keyword">const</span> filter = <span class="function">(<span class="params">state = <span class="string">'SHOW_ALL'</span>, action</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'SET_VISIBILITY_FILTER'</span>:</div><div class="line">            <span class="keyword">return</span> action.filter;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> rootReducer = combineReducers(&#123; todos, filter &#125;);</div><div class="line"></div><div class="line"><span class="comment">/*-- view --*/</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TodoApp</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.props;</div><div class="line">        <span class="keyword">const</span> &#123; todos, filter &#125; = store.getState();</div><div class="line"></div><div class="line">        <span class="keyword">let</span> input;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            &lt;div&gt;</div><div class="line">                &#123;/* AddTodo */&#125;</div><div class="line">                &lt;input type="text" ref=&#123;node =&gt; input = node&#125; /&gt;</div><div class="line">                &lt;button onClick=&#123;() =&gt; &#123;</div><div class="line">                    if (!input.value) return;</div><div class="line"></div><div class="line">                    store.dispatch(addTodo(input.value));</div><div class="line">                    input.value = '';</div><div class="line">                &#125;&#125;&gt;</div><div class="line">                    addTodo</div><div class="line">                &lt;/button&gt;</div><div class="line"></div><div class="line">                &#123;/* TodoList */&#125;</div><div class="line">                &lt;ul&gt;</div><div class="line">                    &#123;</div><div class="line">                        this._getVisibleTodos(todos, filter)</div><div class="line">                            .map(this._renderTodo.bind(this))</div><div class="line">                    &#125;</div><div class="line">                &lt;/ul&gt;</div><div class="line"></div><div class="line">                &#123;/* Footer */&#125;</div><div class="line">                &lt;p&gt;</div><div class="line">                    Show:</div><div class="line">                    &#123;' '&#125;</div><div class="line">                    &#123;this._renderFilter('SHOW_ALL', 'all')&#125;</div><div class="line">                    &#123;', '&#125;</div><div class="line">                    &#123;this._renderFilter('SHOW_COMPLETED', 'completed')&#125;</div><div class="line">                    &#123;', '&#125;</div><div class="line">                    &#123;this._renderFilter('SHOW_ACTIVE', 'active')&#125;</div><div class="line">                &lt;/p&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 订阅 store 的变化</div><div class="line">    componentDidMount() &#123;</div><div class="line">        const &#123; store &#125; = this.props;</div><div class="line"></div><div class="line">        this.unsubscribe = store.subscribe(</div><div class="line">            this.forceUpdate.bind(this)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 取消订阅</div><div class="line">    componentWillUnmount() &#123;</div><div class="line">        this.unsubscribe();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 渲染单个 todo</div><div class="line">    _renderTodo(todo) &#123;</div><div class="line">        const &#123; store &#125; = this.props;</div><div class="line">        </div><div class="line">        return (</div><div class="line">            &lt;li</div><div class="line">                key=&#123;todo.id&#125;</div><div class="line">                onClick=&#123;() =&gt; store.dispatch(toggleTodo(todo.id))&#125;</div><div class="line">                style=&#123;&#123;</div><div class="line">                    textDecoration: todo.completed</div><div class="line">                        ? 'line-through'</div><div class="line">                        : 'none',</div><div class="line">                    cursor: todo.completed</div><div class="line">                        ? 'default'</div><div class="line">                        : 'pointer',</div><div class="line">                &#125;&#125;</div><div class="line">            &gt;</div><div class="line">                &#123;todo.text&#125;</div><div class="line">            &lt;/li&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 根据当前 filter 是否匹配，返回字符串或是 a 链接</div><div class="line">    _renderFilter(renderfilter, name) &#123;</div><div class="line">        const &#123; store &#125; = this.props;</div><div class="line">        const &#123; filter &#125; = store.getState();</div><div class="line"></div><div class="line">        if (renderfilter === filter) return name;</div><div class="line"></div><div class="line">        return (</div><div class="line">            &lt;a href='#' onClick=&#123;e =&gt; &#123;</div><div class="line">                e.preventDefault();</div><div class="line">                store.dispatch(setVisibilityFilter(renderfilter))</div><div class="line">            &#125;&#125;&gt;</div><div class="line">                &#123;name&#125;</div><div class="line">            &lt;/a&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 根据当前 filter 过滤需要渲染的 todos</div><div class="line">    _getVisibleTodos(todos, filter) &#123;</div><div class="line">        switch (filter) &#123;</div><div class="line">            case 'SHOW_ALL':</div><div class="line">                return todos;</div><div class="line"></div><div class="line">            case 'SHOW_COMPLETED':</div><div class="line">                return todos.filter(todo =&gt; todo.completed);</div><div class="line"></div><div class="line">            case 'SHOW_ACTIVE':</div><div class="line">                return todos.filter(todo =&gt; !todo.completed);</div><div class="line"></div><div class="line">            default:</div><div class="line">                return todos;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/*-- ReactDOM 渲染部分 --*/</div><div class="line">ReactDOM.render(</div><div class="line">    &lt;TodoApp store=&#123;createStore(rootReducer, initialState)&#125; /&gt;,</div><div class="line">    document.getElementById('container'),</div><div class="line">);</div></pre></td></tr></table></figure>
<h5 id="2-组件拆分"><a href="#2-组件拆分" class="headerlink" title="(2).组件拆分"></a>(2).组件拆分</h5><p>将所有界面内容写在TodoApp中实在是太臃肿了，接下来根据之前的分析结果将其分为以下子组件（全是展示组件）</p>
<ul>
<li>AddTodo</li>
<li>TodoList<ul>
<li>Todo</li>
</ul>
</li>
<li>Footer<ul>
<li>FilterLink</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> AddTodo = <span class="function">(<span class="params">&#123; onAddClick &#125;</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> input;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">        &lt;div&gt;</div><div class="line">            &lt;input type="text" ref=&#123;node =&gt; input = node&#125; /&gt;</div><div class="line">            &lt;button onClick=&#123;() =&gt; &#123;</div><div class="line">                onAddClick(input.value);</div><div class="line">                input.value = '';</div><div class="line">            &#125;&#125;&gt;</div><div class="line">                addTodo</div><div class="line">            &lt;/button&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">    );</div><div class="line">&#125;;</div><div class="line"></div><div class="line">const Todo = (&#123; text, onClick, completed &#125;) =&gt; (</div><div class="line">    &lt;li</div><div class="line">        onClick=&#123;onClick&#125;</div><div class="line">        style=&#123;&#123;</div><div class="line">            textDecoration: completed</div><div class="line">                ? 'line-through'</div><div class="line">                : 'none',</div><div class="line">            cursor: completed</div><div class="line">                ? 'default'</div><div class="line">                : 'pointer',</div><div class="line">        &#125;&#125;</div><div class="line">    &gt;</div><div class="line">        &#123;text&#125;</div><div class="line">    &lt;/li&gt;</div><div class="line">);</div><div class="line"></div><div class="line">const TodoList = (&#123; todos, onTodoClick &#125;) =&gt; (</div><div class="line">    &lt;ul&gt;</div><div class="line">        &#123;todos.map(todo =&gt;</div><div class="line">            &lt;Todo</div><div class="line">                key=&#123;todo.id&#125;</div><div class="line">                &#123;...todo&#125;</div><div class="line">                onClick=&#123;() =&gt; onTodoClick(todo.id)&#125;</div><div class="line">            /&gt;</div><div class="line">        )&#125;</div><div class="line">    &lt;/ul&gt;</div><div class="line">);</div><div class="line"></div><div class="line">const FilterLink = (&#123; filter, onClick, renderFilter, children &#125;) =&gt; &#123;</div><div class="line">    if (renderFilter === filter) return (&lt;span&gt;&#123;children&#125;&lt;/span&gt;);</div><div class="line">    return (</div><div class="line">        &lt;a href='#' onClick=&#123;e =&gt; &#123;</div><div class="line">            e.preventDefault();</div><div class="line">            onClick(renderFilter);</div><div class="line">        &#125;&#125;&gt;</div><div class="line">            &#123;children&#125;</div><div class="line">        &lt;/a&gt;</div><div class="line">    );</div><div class="line">&#125;;</div><div class="line"></div><div class="line">const Footer = (&#123; filter, onFilterClick &#125;) =&gt; (</div><div class="line">    &lt;p&gt;</div><div class="line">        Show:</div><div class="line">        &#123;' '&#125;</div><div class="line">        &lt;FilterLink</div><div class="line">            filter=&#123;filter&#125;</div><div class="line">            renderFilter="SHOW_ALL"</div><div class="line">            onClick=&#123;onFilterClick&#125;</div><div class="line">        &gt;</div><div class="line">            all</div><div class="line">        &lt;/FilterLink&gt;</div><div class="line">        &#123;', '&#125;</div><div class="line">        &lt;FilterLink</div><div class="line">            filter=&#123;filter&#125;</div><div class="line">            renderFilter="SHOW_COMPLETED"</div><div class="line">            onClick=&#123;onFilterClick&#125;</div><div class="line">        &gt;</div><div class="line">            completed</div><div class="line">        &lt;/FilterLink&gt;</div><div class="line">        &#123;', '&#125;</div><div class="line">        &lt;FilterLink</div><div class="line">            filter=&#123;filter&#125;</div><div class="line">            renderFilter="SHOW_ACTIVE"</div><div class="line">            onClick=&#123;onFilterClick&#125;</div><div class="line">        &gt;</div><div class="line">            active</div><div class="line">        &lt;/FilterLink&gt;</div><div class="line">    &lt;/p&gt;</div><div class="line">);</div></pre></td></tr></table></figure>
<p>所以 TodoApp 精简后是这样~</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TodoApp</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.props;</div><div class="line">        <span class="keyword">const</span> &#123; todos, filter &#125; = store.getState();</div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            &lt;div&gt;</div><div class="line">                &lt;AddTodo</div><div class="line">                    onAddClick=&#123;text =&gt; &#123;</div><div class="line">                        if (!text) return;</div><div class="line">                        store.dispatch(addTodo(text));</div><div class="line">                    &#125;&#125;</div><div class="line">                /&gt;</div><div class="line">                &lt;TodoList</div><div class="line">                    todos=&#123;this._getVisibleTodos(todos, filter)&#125;</div><div class="line">                    onTodoClick=&#123;id =&gt; store.dispatch(toggleTodo(id))&#125;</div><div class="line">                /&gt;</div><div class="line">                &lt;Footer</div><div class="line">                    filter=&#123;filter&#125;</div><div class="line">                    onFilterClick=&#123;filter =&gt; &#123;</div><div class="line">                        store.dispatch(setVisibilityFilter(filter));</div><div class="line">                    &#125;&#125;</div><div class="line">                /&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="3-增加容器组件"><a href="#3-增加容器组件" class="headerlink" title="(3). 增加容器组件"></a>(3). 增加容器组件</h5><p>现在我们仍然是以 TodoApp 作为容器组件，其中各个子组件都是展示组件。</p>
<p>但是这样做的话一旦子组件需要某个属性，就需要从根组件层层传递下来，比如 FilterLink 中的 filter 属性。</p>
<p>所以下面我们增加容器组件，让展示组件通过容器组件获得所需属性。</p>
<ul>
<li>AddTodo(container)</li>
<li>VisibleTodoList(container)<ul>
<li>TodoList</li>
<li>Todo</li>
</ul>
</li>
<li>Footer<ul>
<li>FilterLink(container)<ul>
<li>Link</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// store.dispatch 又被放回来了，</span></div><div class="line"><span class="comment">// 因为暂时我们只在 AddTodo 组件中使用 addTodo 这个 action</span></div><div class="line"><span class="comment">// 以后增加了新的 form 之后可以考虑再将 store.dispatch 移出去</span></div><div class="line"><span class="keyword">const</span> AddTodo = <span class="function">(<span class="params">&#123; store &#125;</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> input;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">        &lt;div&gt;</div><div class="line">            &lt;input type="text" ref=&#123;node =&gt; input = node&#125; /&gt;</div><div class="line">            &lt;button onClick=&#123;() =&gt; &#123;</div><div class="line">                if (!input.value) return;</div><div class="line">                store.dispatch(addTodo(input.value));</div><div class="line">                input.value = '';</div><div class="line">            &#125;&#125;&gt;</div><div class="line">                addTodo</div><div class="line">            &lt;/button&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">    );</div><div class="line">&#125;;</div><div class="line"></div><div class="line">const Todo = (&#123; text, onClick, completed &#125;) =&gt; (</div><div class="line">    &lt;li</div><div class="line">        onClick=&#123;onClick&#125;</div><div class="line">        style=&#123;&#123;</div><div class="line">            textDecoration: completed</div><div class="line">                ? 'line-through'</div><div class="line">                : 'none',</div><div class="line">            cursor: completed</div><div class="line">                ? 'default'</div><div class="line">                : 'pointer',</div><div class="line">        &#125;&#125;</div><div class="line">    &gt;</div><div class="line">        &#123;text&#125;</div><div class="line">    &lt;/li&gt;</div><div class="line">);</div><div class="line"></div><div class="line">const TodoList = (&#123; todos, onTodoClick &#125;) =&gt; (</div><div class="line">    &lt;ul&gt;</div><div class="line">        &#123;todos.map(todo =&gt;</div><div class="line">            &lt;Todo</div><div class="line">                key=&#123;todo.id&#125;</div><div class="line">                &#123;...todo&#125;</div><div class="line">                onClick=&#123;() =&gt; onTodoClick(todo.id)&#125;</div><div class="line">            /&gt;</div><div class="line">        )&#125;</div><div class="line">    &lt;/ul&gt;</div><div class="line">);</div><div class="line">// 容器组件</div><div class="line">class VisibleTodoList extends Component &#123;</div><div class="line">    // 订阅 store 的变化</div><div class="line">    componentDidMount() &#123;</div><div class="line">        const &#123; store &#125; = this.props;</div><div class="line">        this.unsubscribe = store.subscribe(</div><div class="line">            this.forceUpdate.bind(this)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"> </div><div class="line">    // 取消订阅</div><div class="line">    componentWillUnmount() &#123;</div><div class="line">        this.unsubscribe();</div><div class="line">    &#125;</div><div class="line">    // 根据当前 filter 过滤需要渲染的 todos</div><div class="line">    _getVisibleTodos(todos, filter) &#123;</div><div class="line">        switch (filter) &#123;</div><div class="line">            case 'SHOW_ALL':</div><div class="line">                return todos;</div><div class="line">            case 'SHOW_COMPLETED':</div><div class="line">                return todos.filter(todo =&gt; todo.completed);</div><div class="line">            case 'SHOW_ACTIVE':</div><div class="line">                return todos.filter(todo =&gt; !todo.completed);</div><div class="line">            default:</div><div class="line">                return todos;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    render() &#123;</div><div class="line">        const &#123; store &#125; = this.props;</div><div class="line">        const &#123; todos, filter &#125; = store.getState();</div><div class="line">        return (</div><div class="line">            &lt;TodoList</div><div class="line">                todos=&#123;this._getVisibleTodos(todos, filter)&#125;</div><div class="line">                onTodoClick=&#123;id =&gt; &#123;</div><div class="line">                    store.dispatch(toggleTodo(id))</div><div class="line">                &#125;&#125;</div><div class="line">            /&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;   </div><div class="line"></div><div class="line"></div><div class="line">// 原本的 FilterLink 改成 Link，去掉 filter 和 renderFilter 属性，改为传入 active</div><div class="line">const Link = (&#123; active, onClick, children &#125;) =&gt; &#123;</div><div class="line">    if (active) return (&lt;span&gt;&#123;children&#125;&lt;/span&gt;);</div><div class="line">    return (</div><div class="line">        &lt;a href='#' onClick=&#123;e =&gt; &#123;</div><div class="line">            e.preventDefault();</div><div class="line">            onClick();</div><div class="line">        &#125;&#125;&gt;</div><div class="line">            &#123;children&#125;</div><div class="line">        &lt;/a&gt;</div><div class="line">    );</div><div class="line">&#125;;</div><div class="line">// 容器组件</div><div class="line">class FilterLink extends Component &#123;</div><div class="line">    // 订阅 store 的变化</div><div class="line">    componentDidMount() &#123;</div><div class="line">        const &#123; store &#125; = this.props;</div><div class="line">        this.unsubscribe = store.subscribe(</div><div class="line">            this.forceUpdate.bind(this)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">    // 取消订阅</div><div class="line">    componentWillUnmount() &#123;</div><div class="line">        this.unsubscribe();</div><div class="line">    &#125;</div><div class="line">    render() &#123;</div><div class="line">        const &#123; store, renderFilter, children &#125; = this.props;</div><div class="line">        const &#123; filter &#125; = store.getState();</div><div class="line">        return (</div><div class="line">            &lt;Link</div><div class="line">                active=&#123;filter === renderFilter&#125;</div><div class="line">                onClick=&#123;() =&gt; store.dispatch(</div><div class="line">                    setVisibilityFilter(renderFilter)</div><div class="line">                )&#125;</div><div class="line">            &gt;</div><div class="line">                &#123;children&#125;</div><div class="line">            &lt;/Link&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 展示组件</div><div class="line">const Footer = (&#123; store &#125;) =&gt; (</div><div class="line">    &lt;p&gt;</div><div class="line">        Show:</div><div class="line">        &#123;' '&#125;</div><div class="line">        &lt;FilterLink</div><div class="line">            store=&#123;store&#125;</div><div class="line">            renderFilter="SHOW_ALL"</div><div class="line">        &gt;</div><div class="line">            all</div><div class="line">        &lt;/FilterLink&gt;</div><div class="line">        &#123;', '&#125;</div><div class="line">        &lt;FilterLink</div><div class="line">            store=&#123;store&#125;</div><div class="line">            renderFilter="SHOW_COMPLETED"</div><div class="line">        &gt;</div><div class="line">            completed</div><div class="line">        &lt;/FilterLink&gt;</div><div class="line">        &#123;', '&#125;</div><div class="line">        &lt;FilterLink</div><div class="line">            store=&#123;store&#125;</div><div class="line">            renderFilter="SHOW_ACTIVE"</div><div class="line">        &gt;</div><div class="line">            active</div><div class="line">        &lt;/FilterLink&gt;</div><div class="line">    &lt;/p&gt;</div><div class="line">);</div><div class="line">// 在不使用全局变量 store 的情况下，</div><div class="line">// 暂时只能通过 props 传递进来，</div><div class="line">// Don't worry~很快就不会这么麻烦了~</div><div class="line">const TodoApp = (&#123; store &#125;) =&gt; (</div><div class="line">    &lt;div&gt;</div><div class="line">        &lt;AddTodo store=&#123;store&#125; /&gt;</div><div class="line">        &lt;VisibleTodoList store=&#123;store&#125; /&gt;</div><div class="line">        &lt;Footer store=&#123;store&#125; /&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">);</div></pre></td></tr></table></figure>
<p><strong>通过观察重构后的代码可以发现有三点麻烦的地方</strong></p>
<ol>
<li>根组件需要通过 props 将 store 传给各个子组件</li>
<li>容器组件都要定义 componentDidMount 进行订阅和 componentWillUnmount 取消订阅</li>
<li>应用其实并不需要渲染所有的 todos，所以内部很麻烦地定义了 <code>_getVisibleTodos</code> 函数</li>
</ol>
<h5 id="4-Provider"><a href="#4-Provider" class="headerlink" title="(4). Provider"></a>(4). Provider</h5><p>让我们先来解决第一个麻烦~，利用 React 提供的 <a href="http://facebook.github.io/react/docs/context.html" target="_blank" rel="external">context 特性</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="comment">// 通过该方法向 children 的 context 注入 store</span></div><div class="line">    getChildContext() &#123;</div><div class="line">        <span class="keyword">return</span> &#123; <span class="attr">store</span>: <span class="keyword">this</span>.props.store &#125;;</div><div class="line">    &#125;</div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.props.children;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 必须要声明传入 context 的 store 的类型</span></div><div class="line">Provider.childContextTypes = &#123;</div><div class="line">    <span class="attr">store</span>: React.PropTypes.object,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>自顶向下地看以下如何使用到TodoApp中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1. 使用 Provider 包裹 TodoApp，并将 store 作为 props 传入</span></div><div class="line">ReactDOM.render(</div><div class="line">    &lt;Provider store=&#123;createStore(rootReducer, initialState)&#125;&gt;</div><div class="line">        &lt;TodoApp /&gt;</div><div class="line">    &lt;/Provider&gt;,</div><div class="line">    <span class="built_in">document</span>.getElementById(<span class="string">'container'</span>),</div><div class="line">);</div><div class="line"><span class="comment">// 2. 根组件 TodoApp: 和 store say goodbye~，</span></div><div class="line"><span class="comment">// 因为 TodoApp 并不是容器组件~</span></div><div class="line"><span class="keyword">const</span> TodoApp = <span class="function"><span class="params">()</span> =&gt;</span> (</div><div class="line">    &lt;div&gt;</div><div class="line">        &lt;AddTodo /&gt;</div><div class="line">        &lt;VisibleTodoList /&gt;</div><div class="line">        &lt;Footer /&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">);</div><div class="line"><span class="comment">// 3. AddTodo: 由于 props 固定作为第一个传入子组件的参数，</span></div><div class="line"><span class="comment">// 所以 &#123; store &#125; 要声明在第二位，然鹅需要声明 contextTypes...</span></div><div class="line"><span class="keyword">const</span> AddTodo = <span class="function">(<span class="params">props, &#123; store &#125;</span>) =&gt;</span> &#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;;</div><div class="line"><span class="comment">// 必须声明</span></div><div class="line">AddTodo.contextTypes = &#123;</div><div class="line">    <span class="attr">store</span>: React.PropTypes.object,</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 4. VisibleTodoList: 从 props 改成从 context 中获取 store，</span></div><div class="line"><span class="comment">// 同样声明 contextTypes...</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">VisibleTodoList</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="comment">// 订阅 store 的变化</span></div><div class="line">    componentDidMount() &#123;</div><div class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.context; <span class="comment">// props -&gt; context</span></div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.context; <span class="comment">// props -&gt; context</span></div><div class="line">        <span class="keyword">const</span> &#123; todos, filter &#125; = store.getState();</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line">&#125;    </div><div class="line">    </div><div class="line"><span class="comment">// 必须声明</span></div><div class="line">VisibleTodoList.contextTypes = &#123;</div><div class="line">    <span class="attr">store</span>: React.PropTypes.object,</div><div class="line">&#125;;</div><div class="line"><span class="comment">// -- TodoList 和 Todo 不变 --</span></div><div class="line"><span class="comment">// 5. Footer：和 store say goodbye...</span></div><div class="line"><span class="keyword">const</span> Footer = <span class="function"><span class="params">()</span> =&gt;</span> (</div><div class="line">    &lt;p&gt;</div><div class="line">        Show:</div><div class="line">        &#123;' '&#125;</div><div class="line">        &lt;FilterLink renderFilter="SHOW_ALL"&gt;</div><div class="line">            all</div><div class="line">        &lt;/FilterLink&gt;</div><div class="line">        &#123;', '&#125;</div><div class="line">        &lt;FilterLink renderFilter="SHOW_COMPLETED"&gt;</div><div class="line">            completed</div><div class="line">        &lt;/FilterLink&gt;</div><div class="line">        &#123;', '&#125;</div><div class="line">        &lt;FilterLink renderFilter="SHOW_ACTIVE"&gt;</div><div class="line">            active</div><div class="line">        &lt;/FilterLink&gt;</div><div class="line">    &lt;/p&gt;</div><div class="line">);</div><div class="line"><span class="comment">// 6. FilterLink: 同 VisibleTodoList（props + contextTypes...）</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterLink</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="comment">// 订阅 store 的变化</span></div><div class="line">    componentDidMount() &#123;</div><div class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.context; <span class="comment">// props -&gt; context</span></div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">const</span> &#123; renderFilter, children &#125; = <span class="keyword">this</span>.props;</div><div class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.context; <span class="comment">// props -&gt; context</span></div><div class="line">        <span class="keyword">const</span> &#123; filter &#125; = store.getState();</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line">    </div><div class="line"><span class="comment">// 必须声明</span></div><div class="line">FilterLink.contextTypes = &#123;</div><div class="line">    <span class="attr">store</span>: React.PropTypes.object,</div><div class="line">&#125;;</div><div class="line"><span class="comment">// -- Link 不变 --</span></div></pre></td></tr></table></figure>
<p><strong>现在中间的非容器组件完全不用为了自己的孩子而费劲地传递 store={store}</strong><br>所以以上我们就实现了简化版的由 react-redux 提供的第一个组件 <code>&lt;Provider /&gt;</code>。</p>
<p>然鹅，有木有觉得老写 contextTypes 好烦啊，而且 context 特性并不稳定，所以 context 并不应该直接写在我们的应用代码里。</p>
<blockquote>
<p>计将安出？</p>
</blockquote>
<h5 id="5-connect"><a href="#5-connect" class="headerlink" title="(5). connect"></a>(5). connect</h5><p>-OOP思维：这还不简单？写个函数把容器组件传进去作为父类，然后返回写好了 componentDidMount，componentWillUnmount 和 contextTypes 的子类不就好啦~ </p>
<p>恭喜你~面向对象的思想学的很不错~</p>
<p>虽然 JavaScript 底层各种东西都是面向对象，然而在前端一旦与界面相关，照搬面向对象的方法实现起来会很麻烦…</p>
<p>React 早期用户：这还不简单？写个 mixin 岂不美哉~~？<br>作为 react 亲生的 mixin 确实在多组件间共享方法提供了一些便利，然而使用 mixin 的组件需要了解细节，从而避免状态污染，所以一旦 mixin 数量多了之后会越来越难维护。</p>
<blockquote>
<p>Unfortunately, we will not launch any mixin support for ES6 classes in React. That would defeat the purpose of only using idiomatic JavaScript concepts.</p>
</blockquote>
<p>所以官方也放弃了在 ES6 class 中对 mixin 的支持。</p>
<p>函数式（FP）：高阶组件 High Order Component（下称 hoc）才是终极解决方案~~</p>
<p>hocFactory:: W: React.Component =&gt; E: React.Component</p>
<p>如上所示 hoc 的构造函数接收一个 W（代表 WrappedComponent）返回一个 E（代表 Enhanced Component），而 E 就是这个高阶组件。   </p>
<p> 假设我们有一个旧组件 Comp，然鹅现在接收参数有些变动。</p>
<p> 当然你可以复制粘贴再修改旧组件的代码…（大侠受窝一拜）</p>
<p> 也可以这么写，返回一个新组件来包裹旧组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewComp</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">    mapProps(props) &#123;</div><div class="line">        <span class="keyword">return</span> &#123;<span class="comment">/* new props */</span>&#125;;</div><div class="line">    &#125;</div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">return</span> (&lt;Comp &#123;...this.mapProps(this.props)&#125; /&gt;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然鹅，如果有同样逻辑的更多的组件需要适配呢？？？总不能有几个抄几遍吧…</p>
<p><strong>所以骚年你听说过高阶组件么~？</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 先返回一个函数，而那个函数再返回新组件</span></div><div class="line"><span class="keyword">const</span> mapProps = <span class="function"><span class="params">mapFn</span> =&gt;</span> Comp =&gt; &#123;</div><div class="line">    <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">        render() &#123;</div><div class="line">            <span class="keyword">return</span> (&lt;Comp &#123;...this.mapFn(this.props)&#125; /&gt;);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;;</div><div class="line">const NewComp = mapProps(mapFn)(Comp); // 注意调用了两次</div></pre></td></tr></table></figure>
<p>可以看到借助高阶组件我们将 mapFn 和 Comp 解耦合，这样就算需要再嵌套多少修改逻辑都没问题<del>天黑都不怕</del></p>
<p><strong>ok,扯了这么多得淡，终于要说到connect了</strong></p>
<p>是哒，你木有猜错，react-redux 提供的第二个也是最后一个 api —— connect 返回的就是一个高阶组件。</p>
<p>使用的时候只需要 <code>connect()(WrappedComponent)</code> 返回的 component 自动就完成了在 componentDidMount 中订阅 store，在 componentWillUnmount 中取消订阅和声明 contextTypes。</p>
<p><strong>这样就只剩下最后一个麻烦</strong></p>
<blockquote>
<p>应用其实并不需要渲染所有的 todos，所以内部很麻烦地定义了 <code>_getVisibleTodos</code> 函数</p>
</blockquote>
<p>其实 connect 函数的第一个参数叫做 mapStateToProps，作用就是将 store 中的数据提前处理或过滤后作为 props 传入内部组件，以便内部组件高效地直接调用。这样最后一个麻烦也解决了~</p>
<p><strong>然鹅，我们问自己这样就够了么？并没有…</strong></p>
<p>还有最后一个细节，以 FilterLink 为例。    </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterLink</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">const</span> &#123; store, renderFilter, children &#125; = <span class="keyword">this</span>.props;</div><div class="line">        <span class="keyword">const</span> &#123; filter &#125; = store.getState();</div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            &lt;Link</div><div class="line">                active=&#123;filter === renderFilter&#125;</div><div class="line">                onClick=&#123;() =&gt; store.dispatch(</div><div class="line">                    setVisibilityFilter(renderFilter)</div><div class="line">                )&#125;</div><div class="line">            &gt;</div><div class="line">                &#123;children&#125;</div><div class="line">            &lt;/Link&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除了从 store 中获取数据（filter），我们还从中获取了 dispatch，以便触发 action。如果将回调函数 onClick 的内容也加到 props 中，那么借助 connect 整个 FilterLink 的逻辑岂不是都被我们抽象完了？</p>
<p>是哒，connect 的第二个参数叫做 mapDispatchToProps，作用就是将各个调用到 dispatch 的地方都抽象成函数加到 props 中的传给内部组件。这样最后一个麻烦终于真的被解决了~</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> mapStateToLinkProps = <span class="function">(<span class="params">state, ownProps</span>) =&gt;</span> (&#123;</div><div class="line">    <span class="comment">// ownProps 是原组件的 props，</span></div><div class="line">    <span class="comment">// 这里为了和高阶组件的 props 区分</span></div><div class="line">    active: ownProps.renderFilter === state.filter,</div><div class="line">&#125;);</div><div class="line"><span class="keyword">const</span> mapDispatchToLinkProps = <span class="function">(<span class="params">dispatch, ownProps</span>) =&gt;</span> (&#123;</div><div class="line">    onClick() &#123;</div><div class="line">        dispatch(</div><div class="line">            setVisibilityFilter(ownProps.renderFilter)</div><div class="line">        );</div><div class="line">    &#125;,</div><div class="line">&#125;);</div><div class="line"><span class="comment">// 注意原 FilterLink 整个都被我们删了</span></div><div class="line"><span class="keyword">const</span> FilterLink = connect(</div><div class="line">    mapStateToLinkProps,</div><div class="line">    mapDispatchToLinkProps</div><div class="line">)(Link);</div></pre></td></tr></table></figure>
<p><strong>TodoApp 使用react-redux</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 引入 createStore 方法</span></div><div class="line"><span class="keyword">const</span> &#123; createStore, combineReducers &#125; = Redux;</div><div class="line"><span class="keyword">const</span> &#123; Provider, connect &#125; = ReactRedux;</div><div class="line"></div><div class="line"><span class="comment">// 暂且使用数字作为 id</span></div><div class="line"><span class="keyword">let</span> nextTodoId = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="comment">/*-- action creators --*/</span></div><div class="line"><span class="keyword">const</span> addTodo = <span class="function">(<span class="params">text</span>) =&gt;</span> (</div><div class="line">    &#123; <span class="attr">type</span>: <span class="string">'ADD_TODO'</span>, <span class="attr">id</span>: nextTodoId++, text &#125;</div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">const</span> toggleTodo = <span class="function">(<span class="params">id</span>) =&gt;</span> (</div><div class="line">    &#123; <span class="attr">type</span>: <span class="string">'TOGGLE_TODO'</span>, id &#125;</div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">const</span> setVisibilityFilter = <span class="function">(<span class="params">filter</span>) =&gt;</span> (</div><div class="line">    &#123; <span class="attr">type</span>: <span class="string">'SET_VISIBILITY_FILTER'</span>, filter &#125;</div><div class="line">);</div><div class="line"></div><div class="line"><span class="comment">/*-- reducers --*/</span></div><div class="line"><span class="comment">// 默认初始状态</span></div><div class="line"><span class="keyword">const</span> initialState = &#123; <span class="attr">filter</span>: <span class="string">'SHOW_ALL'</span>, <span class="attr">todos</span>: [] &#125;;</div><div class="line"></div><div class="line"><span class="comment">// 处理单个 todo</span></div><div class="line"><span class="keyword">const</span> todo = <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</div><div class="line">            <span class="keyword">return</span> &#123;</div><div class="line">                <span class="attr">id</span>: action.id,</div><div class="line">                <span class="attr">text</span>: action.text,</div><div class="line">                <span class="attr">completed</span>: <span class="literal">false</span>,</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="string">'TOGGLE_TODO'</span>:</div><div class="line">            <span class="keyword">if</span> (state.id !== action.id) <span class="keyword">return</span> state;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> &#123;</div><div class="line">                ...state,</div><div class="line">                <span class="attr">completed</span>: !state.completed,</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 处理 todos</span></div><div class="line"><span class="keyword">const</span> todos = <span class="function">(<span class="params">state = [], action</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</div><div class="line">            <span class="keyword">return</span> [</div><div class="line">                ...state,</div><div class="line">                todo(<span class="literal">undefined</span>, action),</div><div class="line">            ];</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="string">'TOGGLE_TODO'</span>:</div><div class="line">            <span class="keyword">return</span> state.map(<span class="function"><span class="params">t</span> =&gt;</span> todo(t, action));</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 处理 filter</span></div><div class="line"><span class="keyword">const</span> filter = <span class="function">(<span class="params">state = <span class="string">'SHOW_ALL'</span>, action</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">switch</span> (action.type) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'SET_VISIBILITY_FILTER'</span>:</div><div class="line">            <span class="keyword">return</span> action.filter;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> rootReducer = combineReducers(&#123; todos, filter &#125;);</div><div class="line"></div><div class="line"><span class="comment">/*-- view --*/</span></div><div class="line"><span class="comment">// dispatch 作为 props 被传入</span></div><div class="line"><span class="keyword">let</span> AddTodo = <span class="function">(<span class="params">&#123; dispatch &#125;</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> input;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (</div><div class="line">        &lt;div&gt;</div><div class="line">            &lt;input type="text" ref=&#123;node =&gt; input = node&#125; /&gt;</div><div class="line">            &lt;button onClick=&#123;() =&gt; &#123;</div><div class="line">                if (!input.value) return;</div><div class="line"></div><div class="line">                dispatch(addTodo(input.value));</div><div class="line">                input.value = '';</div><div class="line">            &#125;&#125;&gt;</div><div class="line">                addTodo</div><div class="line">            &lt;/button&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">    );</div><div class="line">&#125;;</div><div class="line">AddTodo = connect()(AddTodo); // 注入 dispatch</div><div class="line"></div><div class="line">const Todo = (&#123; text, onClick, completed &#125;) =&gt; (</div><div class="line">    &lt;li</div><div class="line">        onClick=&#123;onClick&#125;</div><div class="line">        style=&#123;&#123;</div><div class="line">            textDecoration: completed</div><div class="line">                ? 'line-through'</div><div class="line">                : 'none',</div><div class="line">            cursor: completed</div><div class="line">                ? 'default'</div><div class="line">                : 'pointer',</div><div class="line">        &#125;&#125;</div><div class="line">    &gt;</div><div class="line">        &#123;text&#125;</div><div class="line">    &lt;/li&gt;</div><div class="line">);</div><div class="line"></div><div class="line">const TodoList = (&#123; todos, onTodoClick &#125;) =&gt; (</div><div class="line">    &lt;ul&gt;</div><div class="line">        &#123;todos.map(todo =&gt;</div><div class="line">            &lt;Todo</div><div class="line">                key=&#123;todo.id&#125;</div><div class="line">                &#123;...todo&#125;</div><div class="line">                onClick=&#123;() =&gt; onTodoClick(todo.id)&#125;</div><div class="line">            /&gt;</div><div class="line">        )&#125;</div><div class="line">    &lt;/ul&gt;</div><div class="line">);</div><div class="line"></div><div class="line">// 根据当前 filter 过滤需要渲染的 todos</div><div class="line">const getVisibleTodos = (todos, filter) =&gt; &#123;</div><div class="line">    switch (filter) &#123;</div><div class="line">        case 'SHOW_ALL':</div><div class="line">            return todos;</div><div class="line"></div><div class="line">        case 'SHOW_COMPLETED':</div><div class="line">            return todos.filter(todo =&gt; todo.completed);</div><div class="line"></div><div class="line">        case 'SHOW_ACTIVE':</div><div class="line">            return todos.filter(todo =&gt; !todo.completed);</div><div class="line"></div><div class="line">        default:</div><div class="line">            return todos;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">const mapStateToTodoListProps = (state) =&gt; (&#123;</div><div class="line">    todos: getVisibleTodos(</div><div class="line">        state.todos,</div><div class="line">        state.filter</div><div class="line">    ),</div><div class="line">&#125;);</div><div class="line"></div><div class="line">const mapDispatchToTodoListProps = (dispatch) =&gt; (&#123;</div><div class="line">    onTodoClick(id) &#123;</div><div class="line">        dispatch(toggleTodo(id))</div><div class="line">    &#125;,</div><div class="line">&#125;);</div><div class="line"></div><div class="line">const VisibleTodoList = connect(</div><div class="line">    mapStateToTodoListProps,</div><div class="line">    mapDispatchToTodoListProps,</div><div class="line">)(TodoList);</div><div class="line"></div><div class="line">// 原本的 FilterLink 改成 Link，去掉 filter 和 renderFilter 属性，改为传入 active</div><div class="line">const Link = (&#123; active, onClick, children &#125;) =&gt; &#123;</div><div class="line">    if (active) return (&lt;span&gt;&#123;children&#125;&lt;/span&gt;);</div><div class="line"></div><div class="line">    return (</div><div class="line">        &lt;a href='#' onClick=&#123;e =&gt; &#123;</div><div class="line">            e.preventDefault();</div><div class="line">            onClick();</div><div class="line">        &#125;&#125;&gt;</div><div class="line">            &#123;children&#125;</div><div class="line">        &lt;/a&gt;</div><div class="line">    );</div><div class="line">&#125;;</div><div class="line"></div><div class="line">const mapStateToLinkProps = (state, ownProps) =&gt; (&#123;</div><div class="line">    // ownProps 是原组件的 props，</div><div class="line">    // 这里为了和高阶组件的 props 区分</div><div class="line">    active: ownProps.renderFilter === state.filter,</div><div class="line">&#125;);</div><div class="line"></div><div class="line">const mapDispatchToLinkProps = (dispatch, ownProps) =&gt; (&#123;</div><div class="line">    onClick() &#123;</div><div class="line">        dispatch(</div><div class="line">            setVisibilityFilter(ownProps.renderFilter)</div><div class="line">        );</div><div class="line">    &#125;,</div><div class="line">&#125;);</div><div class="line"></div><div class="line">// 注意原 FilterLink 整个都被我们删了</div><div class="line">const FilterLink = connect(</div><div class="line">    mapStateToLinkProps,</div><div class="line">    mapDispatchToLinkProps</div><div class="line">)(Link);</div><div class="line"></div><div class="line">const Footer = () =&gt; (</div><div class="line">    &lt;p&gt;</div><div class="line">        Show:</div><div class="line">        &#123;' '&#125;</div><div class="line">        &lt;FilterLink renderFilter="SHOW_ALL"&gt;</div><div class="line">            all</div><div class="line">        &lt;/FilterLink&gt;</div><div class="line">        &#123;', '&#125;</div><div class="line">        &lt;FilterLink renderFilter="SHOW_COMPLETED"&gt;</div><div class="line">            completed</div><div class="line">        &lt;/FilterLink&gt;</div><div class="line">        &#123;', '&#125;</div><div class="line">        &lt;FilterLink renderFilter="SHOW_ACTIVE"&gt;</div><div class="line">            active</div><div class="line">        &lt;/FilterLink&gt;</div><div class="line">    &lt;/p&gt;</div><div class="line">);</div><div class="line"></div><div class="line">// 清清爽爽~再也不用费劲儿地传入 store 了~</div><div class="line">const TodoApp = () =&gt; (</div><div class="line">    &lt;div&gt;</div><div class="line">        &lt;AddTodo /&gt;</div><div class="line">        &lt;VisibleTodoList /&gt;</div><div class="line">        &lt;Footer /&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">);</div><div class="line"></div><div class="line">/*-- ReactDOM 渲染部分 --*/</div><div class="line">ReactDOM.render(</div><div class="line">    &lt;Provider store=&#123;createStore(rootReducer, initialState)&#125;&gt;</div><div class="line">        &lt;TodoApp /&gt;</div><div class="line">    &lt;/Provider&gt;,</div><div class="line">    document.getElementById('container'),</div><div class="line">);</div></pre></td></tr></table></figure>
<h1 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h1><p>本文从 Redux 的理论基础和源码出发，介绍了 Redux 的各项基础 api。</p>
<p>接着一步一步地介绍如何与 React 进行结合，从过程中的各个痛点引出 react-redux 的作用和原理。</p>
<p>然鹅，还有好多的坑没填，比如：大型项目的文件结构、前端路由（react-router）、中间件（middlewares）、网络请求等各类异步操作、服务器端同构直出…</p>
<p>以上 to be continued…</p>
<p>参考引用博客<br><a href="https://buptsteve.github.io/blog/2016/10/25/7.react-and-redux-learning-note-basics/" target="_blank" rel="external">https://buptsteve.github.io/blog/2016/10/25/7.react-and-redux-learning-note-basics/</a></p>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        本文地址：<a href="/blog/2016/12/05/react-and-redux-learning-note-basics/" target="_blank" rel="external">https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/</a>
    </div>
    <footer>
        <a href="https://wudi2010.github.io/blog">
            <img src="/blog/img/avatar.jpg" alt="wudi">
            wudi
        </a>
    </footer>
</blockquote>
        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/React/">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Redux/">Redux</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/&title=《React + Redux 基础学习笔记》 — 吴迪的技术博客&pic=https://wudi2010.github.io/blog/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/&title=《React + Redux 基础学习笔记》 — 吴迪的技术博客&source=天下事有难易乎？为之，则难者亦易矣；不为，则易者亦难矣" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《React + Redux 基础学习笔记》 — 吴迪的技术博客&url=https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/&via=https://wudi2010.github.io/blog" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/blog/2016/12/02/0-blog-first/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">博客第一篇</h4>
      </a>
    </div>
  
</nav>



    
<div class="duoshuo" id="comments">
	<div class="ds-thread" data-thread-key="react-and-redux-learning-note-basics" data-title="React + Redux 基础学习笔记" data-url="https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/"></div>
</div>
<script src="/blog/js/embed.min.js?v=1.3.2"></script>
<script src="//cdn.bootcss.com/marked/0.3.6/marked.min.js" async="async"></script>
<script>
var duoshuoQuery = {short_name:'ysblog', theme: 'none'}
</script>





</article>



</div>

  </main>
  <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>
<script>
var BLOG = { ROOT: '/blog/', SHARE: true, REWARD: false }</script>



<div class="global-share" id="globalShare">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/&title=《React + Redux 基础学习笔记》 — 吴迪的技术博客&pic=https://wudi2010.github.io/blog/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/&title=《React + Redux 基础学习笔记》 — 吴迪的技术博客&source=天下事有难易乎？为之，则难者亦易矣；不为，则易者亦难矣" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《React + Redux 基础学习笔记》 — 吴迪的技术博客&url=https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/&via=https://wudi2010.github.io/blog" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="http://s.jiathis.com/qrcode.php?url=https://wudi2010.github.io/blog/2016/12/05/react-and-redux-learning-note-basics/" alt="微信分享二维码">
</div>




  <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script src="/blog/js/main.min.js?v=1.3.2"></script>



<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/blog/js/search.min.js?v=1.3.2"></script>









</body>
</html>
